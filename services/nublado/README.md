# nublado

Service to manage user labs

**Homepage:** <https://github.com/lsst-sqre/jupyterlab-controller>

## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| affinity | object | `{}` | Affinity rules for the nublado frontend pod |
| controller.form.forms | object | `{"default":"<script>\nfunction selectDropdown() {\n    document.getElementById('{{ dropdown_sentinel }}').checked = true;\n}\n</script>\n<style>\n    td {\n        border: 1px solid black;\n        padding: 2%;\n        vertical-align: top;\n    }\n    .radio label,\n    .checkbox label {\n        padding-left: 0px;\n    }\n</style>\n<table width=\"100%\">\n<tr>\n  <th>Image</th>\n  <th>Options</th>\n</tr>\n<tr>\n<td width=\"50%\">\n  <div class=\"radio radio-inline\">\n{% for i in cached_images %}\n    <input type=\"radio\" name=\"image_list\"\n     id=\"image{{ loop.index }}\" value=\"{{ i.path }}\"\n     {% if loop.first %} checked {% endif %}\n    >\n    <label for=\"image{{ loop.index }}\">{{ i.name }}</label><br />\n{% endfor %}\n    <input type=\"radio\" name=\"image_list\"\n        id=\"{{ dropdown_sentinel }}\"\n        value=\"{{ dropdown_sentinel }}\"\n        {% if not cached_images %} checked {% endif %}\n    >\n    <label for=\"{{ dropdown_sentinel }}\">\n      Select uncached image (slower start):\n    </label><br />\n    <select name=\"image_dropdown\" onclick=\"selectDropdown()\">\n    {% for i in all_images %}\n        <option value=\"{{ i.path }}\">{{ i.name }}</option>\n    {% endfor %}\n    </select>\n  </div>\n</td>\n<td width=\"50%\">\n  <div class=\"radio radio-inline\">\n{% for s in sizes %}\n    <input type=\"radio\" name=\"size\"\n     id=\"{{ s.name }}\" value=\"{{ s.name }}\"\n     {% if loop.first %} checked {% endif %}\n    >\n    <label for=\"{{ s.name }}\">\n      {{ s.name }} ({{ s.cpu }} CPU, {{ s.memory }} RAM)\n    </label><br />\n{% endfor %}\n  </div>\n  <br />\n  <br />\n  <div class=\"checkbox checkbox-inline\">\n    <input type=\"checkbox\" id=\"enable_debug\"\n     name=\"enable_debug\" value=\"false\">\n    <label for=\"enable_debug\">Enable debug logs</label><br />\n\n    <input type=\"checkbox\" id=\"reset_user_env\"\n     name=\"reset_user_env\" value=\"false\">\n    <label for=\"reset_user_env\">\n      Reset user environment: relocate .cache, .jupyter, and .local\n    </label><br />\n  </div>\n</td>\n</tr>\n</table>\n"}` | options form template text keyed by group name. "default" is always present. |
| controller.kubernetes | object | `{"request_timeout":60}` | Kubernetes API settings |
| controller.kubernetes.request_timeout | int | `60` | timeout in seconds for kubernetes API requests. |
| controller.lab | object | `{"env":{"API_ROUTE":"/api","AUTO_REPO_SPECS":"https://github.com/lsst-sqre/system-test@prod,https://github.com/rubin-dp0/tutorial-notebooks@prod","CULL_KERNEL_CONNECTED":"True","CULL_KERNEL_IDLE_TIMEOUT":"432000","CULL_KERNEL_INTERVAL":"300","DAF_BUTLER_REPOSITORY_INDEX":"s3://butler-us-central1-repo-locations/data-repos.yaml","FIREFLY_ROUTE":"/portal/app","HUB_ROUTE":"/nb/hub","JUPYTERHUB_ADMIN_ACCESS":"1","JUPYTERHUB_API_URL":"http://hub.nublado2:8081/nb/hub/api","JUPYTERHUB_BASE_URL":"/nb/","JUPYTERHUB_DEFAULT_URL":"/lab","JUPYTERHUB_OAUTH_CLIENT_ALLOWED_SCOPES":"[]","NO_ACTIVITY_TIMEOUT":"432000","NO_SUDO":"TRUE","S3_ENDPOINT_URL":"https://storage.googleapis.com","SODA_ROUTE":"/api/image/soda","TAP_ROUTE":"/api/tap"},"files":[{"contents":"root:x:0:0:root:/root:/bin/bash\nbin:x:1:1:bin:/bin:/sbin/nologin\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\nadm:x:3:4:adm:/var/adm:/sbin/nologin\nlp:x:4:7:lp:/var/spool/lpd:/sbin/nologin\nsync:x:5:0:sync:/sbin:/bin/sync\nshutdown:x:6:0:shutdown:/sbin:/sbin/shutdown\nhalt:x:7:0:halt:/sbin:/sbin/halt\nmail:x:8:12:mail:/var/spool/mail:/sbin/nologin\noperator:x:11:0:operator:/root:/sbin/nologin\ngames:x:12:100:games:/usr/games:/sbin/nologin\nftp:x:14:50:FTP User:/var/ftp:/sbin/nologin\ntss:x:59:59:Account used by the trousers package to sandbox the tcsd daemon:/dev/null:/sbin/nologin\ndbus:x:81:81:System message bus:/:/sbin/nologin\nnobody:x:99:99:Nobody:/:/sbin/nologin\nsystemd-network:x:192:192:systemd Network Management:/:/sbin/nologin\nlsst_lcl:x:1000:1000::/home/lsst_lcl:/bin/bash\n","modify":true,"mountPath":"/etc/passwd","name":"passwd"},{"contents":"root:x:0:\nbin:x:1:\ndaemon:x:2:\nsys:x:3:\nadm:x:4:\ntty:x:5:\ndisk:x:6:\nlp:x:7:\nmem:x:8:\nkmem:x:9:\nwheel:x:10:\ncdrom:x:11:\nmail:x:12:\nman:x:15:\ndialout:x:18:\nfloppy:x:19:\ngames:x:20:\nutmp:x:22:\ntape:x:33:\nutempter:x:35:\nvideo:x:39:\nftp:x:50:\nlock:x:54:\ntss:x:59:\naudio:x:63:\ndbus:x:81:\nscreen:x:84:\nnobody:x:99:\nusers:x:100:\nsystemd-journal:x:190:\nsystemd-network:x:192:\ncgred:x:997:\nssh_keys:x:998:\ninput:x:999:\n","modify":true,"mountPath":"/etc/group","name":"group"},{"contents":"# No longer used, but preserves compatibility with runlab.sh\ndask_worker.yml: |\n  enabled: false\n","mountPath":"/opt/lsst/software/jupyterlab/lsst_dask.yml","name":"dask-config"},{"contents":"# Licensed under the Apache License, Version 2.0 (the \"License\");\n# You may not use this file except in compliance with the License.\n# You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0\n#\n# Authors:\n# - Wen Guan, <wen.guan@cern.ch>, 2020\n[common]\n# if logdir is configured, idds will write to idds.log in this directory.\n# else idds will go to stdout/stderr.\n# With supervisord, it's good to write to stdout/stderr, then supervisord can manage and rotate logs.\n# logdir = /var/log/idds\nloglevel = INFO\n[rest]\nhost = https://iddsserver.cern.ch:443/idds\n#url_prefix = /idds\n#cacher_dir = /tmp\ncacher_dir = /data/idds\n","modify":false,"mountPath":"/opt/lsst/software/jupyterlab/panda","name":"idds-config"}],"form":{"restrictions":[]},"initcontainers":[],"quota":{"cpu":81,"memory":"243Gi"},"secrets":[{"env":"AWS_SHARED_CREDENTIALS_FILE","mountPath":"/opt/lsst/software/jupyterlab/butler-secret/aws-credentials.ini","name":"aws-credentials.ini"},{"env":"GOOGLE_APPLICATION_CREDENTIALS","mountPath":"/opt/lsst/software/jupyterlab/butler-secret/butler-gcs-idf-creds.json","name":"butler-gcs-idf-creds.json"},{"mountPath":"/opt/lsst/software/jupyterlab/butler-secret/butler-hmac-idf-creds.json","name":"butler-hmac-idf-creds.json"},{"env":"PGPASSFILE","mountPath":"/opt/lsst/software/jupyterlab/butler-secret/postgres-credentials.txt","name":"postgres-credentials.txt"}],"sizes":{"large":{"cpu":4,"memory":"12Gi"},"medium":{"cpu":2,"memory":"6Gi"},"small":{"cpu":1,"memory":"3Gi"}},"volume_mounts":[{"mountPath":"/home","name":"home"},{"mountPath":"/project","name":"project"},{"mountPath":"/scratch","name":"scratch"}],"volumes":[{"name":"home","nfs":{"path":"/share1/home","server":"10.13.105.122"}},{"name":"project","nfs":{"path":"/share1/project","server":"10.13.105.122"}},{"name":"scratch","nfs":{"path":"/share1/scratch","server":"10.13.105.122"}}]}` | Settings for the JupyterLab controller |
| controller.lab.env | object | `{"API_ROUTE":"/api","AUTO_REPO_SPECS":"https://github.com/lsst-sqre/system-test@prod,https://github.com/rubin-dp0/tutorial-notebooks@prod","CULL_KERNEL_CONNECTED":"True","CULL_KERNEL_IDLE_TIMEOUT":"432000","CULL_KERNEL_INTERVAL":"300","DAF_BUTLER_REPOSITORY_INDEX":"s3://butler-us-central1-repo-locations/data-repos.yaml","FIREFLY_ROUTE":"/portal/app","HUB_ROUTE":"/nb/hub","JUPYTERHUB_ADMIN_ACCESS":"1","JUPYTERHUB_API_URL":"http://hub.nublado2:8081/nb/hub/api","JUPYTERHUB_BASE_URL":"/nb/","JUPYTERHUB_DEFAULT_URL":"/lab","JUPYTERHUB_OAUTH_CLIENT_ALLOWED_SCOPES":"[]","NO_ACTIVITY_TIMEOUT":"432000","NO_SUDO":"TRUE","S3_ENDPOINT_URL":"https://storage.googleapis.com","SODA_ROUTE":"/api/image/soda","TAP_ROUTE":"/api/tap"}` | Environment variables for user lab pods, common to all lab pods in this RSP instance. |
| controller.lab.files | list | `[{"contents":"root:x:0:0:root:/root:/bin/bash\nbin:x:1:1:bin:/bin:/sbin/nologin\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\nadm:x:3:4:adm:/var/adm:/sbin/nologin\nlp:x:4:7:lp:/var/spool/lpd:/sbin/nologin\nsync:x:5:0:sync:/sbin:/bin/sync\nshutdown:x:6:0:shutdown:/sbin:/sbin/shutdown\nhalt:x:7:0:halt:/sbin:/sbin/halt\nmail:x:8:12:mail:/var/spool/mail:/sbin/nologin\noperator:x:11:0:operator:/root:/sbin/nologin\ngames:x:12:100:games:/usr/games:/sbin/nologin\nftp:x:14:50:FTP User:/var/ftp:/sbin/nologin\ntss:x:59:59:Account used by the trousers package to sandbox the tcsd daemon:/dev/null:/sbin/nologin\ndbus:x:81:81:System message bus:/:/sbin/nologin\nnobody:x:99:99:Nobody:/:/sbin/nologin\nsystemd-network:x:192:192:systemd Network Management:/:/sbin/nologin\nlsst_lcl:x:1000:1000::/home/lsst_lcl:/bin/bash\n","modify":true,"mountPath":"/etc/passwd","name":"passwd"},{"contents":"root:x:0:\nbin:x:1:\ndaemon:x:2:\nsys:x:3:\nadm:x:4:\ntty:x:5:\ndisk:x:6:\nlp:x:7:\nmem:x:8:\nkmem:x:9:\nwheel:x:10:\ncdrom:x:11:\nmail:x:12:\nman:x:15:\ndialout:x:18:\nfloppy:x:19:\ngames:x:20:\nutmp:x:22:\ntape:x:33:\nutempter:x:35:\nvideo:x:39:\nftp:x:50:\nlock:x:54:\ntss:x:59:\naudio:x:63:\ndbus:x:81:\nscreen:x:84:\nnobody:x:99:\nusers:x:100:\nsystemd-journal:x:190:\nsystemd-network:x:192:\ncgred:x:997:\nssh_keys:x:998:\ninput:x:999:\n","modify":true,"mountPath":"/etc/group","name":"group"},{"contents":"# No longer used, but preserves compatibility with runlab.sh\ndask_worker.yml: |\n  enabled: false\n","mountPath":"/opt/lsst/software/jupyterlab/lsst_dask.yml","name":"dask-config"},{"contents":"# Licensed under the Apache License, Version 2.0 (the \"License\");\n# You may not use this file except in compliance with the License.\n# You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0\n#\n# Authors:\n# - Wen Guan, <wen.guan@cern.ch>, 2020\n[common]\n# if logdir is configured, idds will write to idds.log in this directory.\n# else idds will go to stdout/stderr.\n# With supervisord, it's good to write to stdout/stderr, then supervisord can manage and rotate logs.\n# logdir = /var/log/idds\nloglevel = INFO\n[rest]\nhost = https://iddsserver.cern.ch:443/idds\n#url_prefix = /idds\n#cacher_dir = /tmp\ncacher_dir = /data/idds\n","modify":false,"mountPath":"/opt/lsst/software/jupyterlab/panda","name":"idds-config"}]` | Files to be mounted as ConfigMaps inside the user lab pod. Some of these will require modification.  Those are noted with modify: true, and the file name will be the unique key directing how the Lab controller is to modify it. |
| controller.lab.form.restrictions | list | `[]` | Lab form restrictions.  It's a list of objects where each object has three fields, 'type', 'value', and 'groups'.  'type' must be one of "size", "image", or "tag".  'value' is a regular expression matching a string that is an allowed value for 'type'. 'groups', if specified, is a list of group names allowed to use a resource where 'type' matches 'value'.  An empty list is unrestricted. |
| controller.lab.initcontainers | list | `[]` | List of specifications for containers to run to commission a new user. |
| controller.lab.quota | object | `{"cpu":81,"memory":"243Gi"}` | Maximum CPU/memory resources for user namespace |
| controller.lab.secrets | list | `[{"env":"AWS_SHARED_CREDENTIALS_FILE","mountPath":"/opt/lsst/software/jupyterlab/butler-secret/aws-credentials.ini","name":"aws-credentials.ini"},{"env":"GOOGLE_APPLICATION_CREDENTIALS","mountPath":"/opt/lsst/software/jupyterlab/butler-secret/butler-gcs-idf-creds.json","name":"butler-gcs-idf-creds.json"},{"mountPath":"/opt/lsst/software/jupyterlab/butler-secret/butler-hmac-idf-creds.json","name":"butler-hmac-idf-creds.json"},{"env":"PGPASSFILE","mountPath":"/opt/lsst/software/jupyterlab/butler-secret/postgres-credentials.txt","name":"postgres-credentials.txt"}]` | Secrets for injection into user lab pods.  The name is again the unique key that allows the Lab Controller to create the contents.  Since these are stored as secrets, they will be created from whole cloth, rather than modified from a base template. If 'env' is specified, the mountPath will be stored in that environment variable. |
| controller.lab.volume_mounts | list | `[{"mountPath":"/home","name":"home"},{"mountPath":"/project","name":"project"},{"mountPath":"/scratch","name":"scratch"}]` | Volume Mounts corresponding to user lab pod Volumes |
| controller.lab.volumes | list | `[{"name":"home","nfs":{"path":"/share1/home","server":"10.13.105.122"}},{"name":"project","nfs":{"path":"/share1/project","server":"10.13.105.122"}},{"name":"scratch","nfs":{"path":"/share1/scratch","server":"10.13.105.122"}}]` | Volumes defined to user lab pods |
| controller.prepuller.docker.repository | string | `"library/sketchbook"` |  |
| controller.prepuller.numDailies | int | `3` |  |
| controller.prepuller.numReleases | int | `1` |  |
| controller.prepuller.numWeeklies | int | `2` |  |
| controller.prepuller.pollInterval | int | `60` |  |
| controller.prepuller.recommendedTag | string | `"recommended"` |  |
| controller.prepuller.registry | string | `"lighthouse.ceres"` | config from sqr-066 |
| controller.safir | object | `{"log_level":"DEBUG","logger_name":"jupyterlabcontroller","name":"jupyterlab-controller","profile":"development"}` | safir settings; generically set through environment variables, but we'd rather do it this way and just control all config through the ConfigMap |
| controller.safir.logger_name | string | `"jupyterlabcontroller"` | Root name of the application's logger. |
| controller.safir.name | string | `"jupyterlab-controller"` | The application's name (not the root HTTP endpoint path) |
| controller.safir.profile | string | `"development"` | Application run profile: "development" or "production" |
| fullnameOverride | string | `""` | Override the full name for resources (includes the release name) |
| global.baseUrl | string | Set by Argo CD | Base URL for the environment |
| global.host | string | Set by Argo CD | Host name for ingress |
| global.vaultSecretsPath | string | Set by Argo CD | Base path for Vault secrets |
| image.pullPolicy | string | `"IfNotPresent"` | Pull policy for the nublado image |
| image.repository | string | `"lsstsqre/nublado"` | nublado image to use |
| image.tag | string | The appVersion of the chart | Tag of nublado image to use |
| ingress.annotations | object | `{}` | Additional annotations to add for endpoints that are authenticated. |
| nameOverride | string | `""` | Override the base name for resources |
| nodeSelector | object | `{}` | Node selector rules for the nublado frontend pod |
| podAnnotations | object | `{}` | Annotations for the nublado frontend pod |
| resources | object | `{}` | Resource limits and requests for the nublado frontend pod |
| serviceAccount | object | `{"annotations":{},"name":""}` | Secret names to use for all Docker pulls |
| serviceAccount.annotations | object | `{}` | Annotations to add to the service account |
| serviceAccount.name | string | Name based on the fullname template | Name of the service account to use |
| tolerations | list | `[]` | Tolerations for the nublado frontend pod |
